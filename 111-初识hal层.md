# 11.1 初识HAL层

HAL（Hardware Abstraction Layer）层又被称为硬件抽象层，是建立在Linux驱动上的一套程序库，主要作用是对Linux内核驱动程序的封装，向上提供接口，屏蔽底层的实现细节。HAL层运行在用户空间，属于Linux内核层之上的应用层。Google这样设计的原因，主要是为了保护各硬件厂商的利益。也正是因为如此，Android被踢出了Linux内核主线代码树。

Linux内核采用了GPL协议，这要求Linux内核在发布时必须公布所有源代码。如果把对硬件的支持逻辑放在Linux驱动层，则在公布源代码的时候把硬件的相关参数和实现也同时公开了，这设计到了技术专利和商业秘密，会对硬件厂商的利益造成很大的损害。正是为了保护这些厂商的利益，Google才决定将对硬件的支持分为了硬件抽象层和内核驱动层。

 
在Android系统中，业务逻辑代码通常放在硬件抽象层中，Linux内核层只保留与寄存器交互的代码。也就是说，Linux驱动相当于一个空壳，仅提供简单的硬件访问逻辑，例如读写硬件寄存器的通道，至于从硬件中读到了什么值或者写了什么值到硬件中的逻辑，都放在硬件抽象层中去了。有了硬件抽象层后，Android Framework与Linux Kernel被分隔开来，Android不至于过度依赖Linux Kernel，因此达成了Kernel Independent的概念，Android Framework的开发也能够在不考虑驱动程序的前提下进行发展。硬件抽象层提供了简单的设备驱动程序接口，应用程序使用设备驱动程序与底层硬件进行通信，另外，硬件抽象层的应用程序接口和ANSIC标准库结合在一起，用户可以使用C语言函数来访问Android文件系统。

总之，Google为Android加入HAL主要有如下目的：

1.统一硬件的调用接口。由于HAL有标准的调用接口，所以可以利用HAL屏蔽Linux驱动复杂、不统一的接口。

2.解决了GPL版权问题。由于Linux内核基于GPL协议，而Android基于Apache License 2.0协议。因此Google玩了个“穿越”，将原本位于Linux驱动中的敏感代码向上移了一个层次。这样这些敏感代码就摆脱了GPL协议的束缚，那些不想开源的Linux驱动作者也就没必要开源了。

3.针对一些特殊的要求。对于有些硬件，可能需要访问一些用户空间的资源，或在内核空间不方便完成的工作以及特殊需求。在这种情况下，可以利用位于用户空间的HAL代码来辅助Linux驱动完成一些工作。
